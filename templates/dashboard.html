{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block content %}
<h2>ëŒ€ì‹œë³´ë“œ</h2>

<!-- ğŸ” ìƒí’ˆ ê²€ìƒ‰ í¼ -->
<form action="{{ url_for('search') }}" method="get" class="mb-4 d-flex gap-2">
  <input type="text" name="q" class="form-control" placeholder="ìƒí’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰" value="{{ request.args.q or '' }}">
  <select name="sort" class="form-select">
    <option value="recent">ìµœì‹ ìˆœ</option>
    <option value="price">ê°€ê²© ë‚®ì€ìˆœ</option>
    <option value="popular">ì¸ê¸°ìˆœ</option>
  </select>
  <input type="text" name="category" class="form-control" placeholder="ì¹´í…Œê³ ë¦¬ (ì„ íƒ)" value="{{ request.args.category or '' }}">
  <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
</form>

<h3>ë“±ë¡ëœ ìƒí’ˆ</h3>
<ul>
  {% for product in products %}
    <li>
      <a href="{{ url_for('view_product', product_id=product.id) }}">{{ product.title }}</a>
    </li>
  {% endfor %}
</ul>
<p><a href="{{ url_for('new_product') }}">ìƒˆ ìƒí’ˆ ë“±ë¡</a></p>
<p><a href="{{ url_for('send_money') }}">ğŸ’¸ ì†¡ê¸ˆí•˜ê¸°</a></p>

<h3>ê±°ë˜ ë‚´ì—­</h3>
<table border="1">
    <tr>
        <th>ì†¡ì‹ ì</th>
        <th>ìˆ˜ì‹ ì</th>
        <th>ê¸ˆì•¡</th>
        <th>ì‹œê°„</th>
    </tr>
    {% for transaction in transactions %}
    <tr>
        <td>{{ transaction.sender }}</td>
        <td>{{ transaction.receiver }}</td>
        <td>{{ transaction.amount }} ì›</td>
        <td>{{ transaction.timestamp }}</td>
    </tr>
    {% endfor %}
</table>

<div class="balance-section">
  <h3>ë‚´ ì”ì•¡: {{ balance }} ì›</h3>
  <a href="{{ url_for('top_up') }}" class="btn btn-primary">ì¶©ì „í•˜ê¸°</a>
</div>

{% if user['username'] == 'admin' %}
<hr>
<h4>ğŸ”§ ê´€ë¦¬ì ì „ìš©</h4>
<p><a href="{{ url_for('admin_panel') }}">ê´€ë¦¬ì í˜ì´ì§€ ì´ë™</a></p>
{% endif %}


<h3>ì‹¤ì‹œê°„ ì±„íŒ…</h3>
<div id="chat">
  <ul id="messages"></ul>
  <input id="chat_input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
  <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<hr>
<h4>1:1 ì±„íŒ… ìœ ì € ëª©ë¡</h4>
{% if other_users %}
<ul class="list-group">
  {% for u in other_users %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    {{ u['username'] }}
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('private_chat', target_username=u['username']) }}">
      ì±„íŒ…í•˜ê¸°
    </a>
  </li>
  {% endfor %}
</ul>
{% else %}
  <p class="text-muted">í˜„ì¬ ì±„íŒ…í•  ìˆ˜ ìˆëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<script type="text/javascript">
  var socket = io();
  socket.on('connect', function() {
    console.log("ì±„íŒ… ì„œë²„ì— ì—°ê²°ë¨");
  });
  socket.on('message', function(data) {
    var messages = document.getElementById('messages');
    var item = document.createElement('li');
    item.textContent = data.username + ": " + data.message;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
  });
  function sendMessage() {
    var input = document.getElementById('chat_input');
    var message = input.value;
    if (message) {
      socket.emit('send_message', { 'username': "{{ user['username'] }}", 'message': message });
      input.value = "";
    }
  }
</script>
{% endblock %}
